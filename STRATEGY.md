# OBI 스캘핑 전략 - 분석 및 최적화

## 현재 전략 개요

### 호가 불균형(OBI) 기반 전략

**신호 계산 방식:**
- OBI = `bid_volume / (bid_volume + ask_volume)` (상위 N단계 기준)
- 각 호가 단계에서 `sum(price * quantity)`로 가중 평균 계산
- 현재 사용 중인 Depth Level: 5 (변경 가능)

**거래 기준:**
- **롱 진입**: OBI ≥ 0.70 (70% 이상 매수 우위)
- **숏 진입**: OBI ≤ 0.30 (30% 이하 매수 우위)
- **중립 구간**: 0.30 < OBI < 0.70 (신호 없음)

**리스크 관리:**
- **익절 (Take Profit)**: 0.05% (0.0005)
- **손절 (Stop Loss)**: 0.05% (0.0005)
- **포지션 크기**: 트레이드당 20 USDT
- **주문 TTL**: 2.0초 (설정은 있으나 미구현 상태)

---

## 전략 성능 분석

### 강점

1. **시장 미시구조 반영**: 단기 유동성 불균형을 잘 포착
2. **Post-Only 주문 활용**: 스프레드를 활용한 수익 창출 가능
3. **대칭적 리스크 설정**: TP/SL이 동일해 방향성 편향 적음
4. **낮은 지연시간**: WebSocket 기반 실시간 처리

### 주요 문제점

#### 1. 신호 품질 문제
- 고정 임계값은 시장 변동성에 대응하지 못함
- 신호 스무딩 부재로 오신호 다수 발생
- 시장 트렌드나 변동성 레짐을 고려하지 않음

#### 2. 실행 리스크
- 중간 가격에 주문을 넣는 방식은 스프레드 이점을 주지 못함
- 메인 루프에 200ms 대기 → 신호 실행 지연 발생
- TTL 미구현으로 주문이 스택에 오래 남아 있음

#### 3. 리스크 관리 부족
- 변동성과 무관한 고정 포지션 크기
- 일일 손실 제한이나 총 노출량 제한 없음
- TP/SL이 항상 대칭이지만 상황에 따라 비효율적일 수 있음

#### 4. 성과 측정 부족
- Sharpe 비율, 승률, 트레이드 지속시간 등의 전략 지표 없음
- 최대 낙폭 관리 없음
- 성과 분석용 로깅 부족

---

## 최적화 권고안

### Phase 1: 신호 개선 (우선순위 높음)

- **적응형 임계값**: 과거 OBI 평균 ± 표준편차 기반으로 동적으로 조정
- **신호 스무딩**: 지수 이동 평균(EMA)을 사용해 노이즈 감소
- **멀티 레벨 컨플루언스**: 다양한 Depth Level에서의 신호 일치 확인

### Phase 2: 실행 최적화 (우선순위 높음)

- **스마트 주문 배치**: 스프레드 내부 유리한 위치에 주문
- **TTL 구현**: 지정된 시간 이후 미체결 주문 자동 취소

### Phase 3: 리스크 관리 개선 (우선순위 중간)

- **동적 포지션 크기**: 변동성 기반으로 포지션 크기를 조절
- **포트폴리오 제한**:
  - 최대 일일 손실: -100 USDT
  - 동시 포지션 수: 최대 5개
  - 총 노출 자산: 200 USDT 이하

### Phase 4: 성과 측정 기능 추가 (우선순위 중간)

- 실시간 PnL, 최대 낙폭, 승률, Sharpe 비율 등 지표 계산
- 트레이드 별 성과 데이터 저장

---

## 구현 우선순위

### 즉시 시행 (1주차)
- 주문 TTL 기능 구현
- 적응형 임계값 적용
- 스마트 주문 배치 로직 적용
- 기본 포트폴리오 제약 설정

### 단기 목표 (2~3주차)
- 신호 스무딩 적용
- 동적 포지션 사이징 구현
- 전략 성과 지표 추적
- 멀티 레벨 컨플루언스 적용

### 중기 목표 (1개월 이내)
- 시장 상태 탐지(레짐 디텍션) 시스템 구축
- 고급 주문 관리 시스템 도입
- 완전한 백테스트 프레임워크 구현
- 전략 파라미터 자동 최적화 기능 개발

---

## 기대 효과

### 신호 품질 향상
- 오신호 감소 (30~40% 감소 예상)
- 진입 정밀도 향상 (컨플루언스 적용)
- 시장 적응력 확보 (동적 파라미터)

### 주문 실행 개선
- 체결률 증가 (20~25% 향상 예상)
- TTL 적용으로 불리한 체결 방지
- Sharpe 비율 향상 기대

### 리스크 관리 고도화
- 일일 손실 제한으로 최대 낙폭 제어
- 변동성에 따라 적절한 자산 배분
- 효율적 자본 운용 가능

---

## 백테스트 준비 사항

1. **과거 호가 데이터 수집**: BTCUSDT 기준 3~6개월치
2. **전략 시뮬레이션 구현**: 체결까지 포함한 시뮬레이션 환경 구축
3. **워크포워드 최적화**: 과최적화 방지 위한 구간별 검증
4. **검증용 데이터 분리**: 전체의 20%는 검증용(out-of-sample)으로 사용

---

## 리스크 고려사항

### 구현 리스크
- 과도한 최적화로 인한 실전 부진 위험
- 지연시간 변화가 전략 성능에 미치는 영향
- 트렌드 vs 횡보장 등 시장 상태 변화에 따라 성과 차이 발생 가능

### 운영 리스크
- 시스템 다운타임 대비 로직 필요 (예: 자동 재연결)
- 바이낸스 API 호출 제한 주의
- 포지션 상태 검증 로직 필수